name: Canvas Assignment Sync

on:
  push:
    branches:
      - main
    paths:
      - '**.md'

jobs:
  sync-canvas:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits for git diff
      
      - name: Setup SSH for private submodule
        run: |
          # Check if SSH key secret exists (if not, submodule might be public)
          if [ -z "${{ secrets.SUBMODULE_SSH_KEY }}" ]; then
            echo "SUBMODULE_SSH_KEY secret not found. Assuming canvastest is public or using HTTPS."
            exit 0
          fi
          
          mkdir -p ~/.ssh
          echo "${{ secrets.SUBMODULE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          # Configure git to use SSH for canvastest submodule
          git config --file=.gitmodules submodule.canvastest.url git@github.com:timothyfraser/canvastest.git
      
      - name: Checkout submodules
        run: |
          git submodule sync
          git submodule update --init --recursive || (echo "Submodule checkout failed. If canvastest is private, ensure SUBMODULE_SSH_KEY secret is configured." && exit 1)
        
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
        
      - name: Install R dependencies
        run: |
          Rscript -e "install.packages(c('httr2', 'jsonlite', 'dplyr', 'readr'), repos = 'https://cloud.r-project.org')"
        
      - name: Detect changed assignment files
        id: changed-files
        run: |
          # Get list of changed .md files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.md$' || true)
          
          # Filter to assignment files matching patterns
          ASSIGNMENT_FILES=""
          for file in $CHANGED_FILES; do
            filename=$(basename "$file")
            if [[ "$filename" =~ ^(ACTIVITY_|LAB_|HOMEWORK|TOOL) ]]; then
              ASSIGNMENT_FILES="${ASSIGNMENT_FILES}${file}\n"
            fi
          done
          
          # Remove trailing newline and save to file
          echo -e "$ASSIGNMENT_FILES" | sed '/^$/d' > changed_assignments.txt
          
          # Count files
          FILE_COUNT=$(wc -l < changed_assignments.txt | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          # Display found files (for debugging, but don't log full paths if empty)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "Found $FILE_COUNT changed assignment file(s):"
            cat changed_assignments.txt
          else
            echo "No changed assignment files found"
          fi
        
      - name: Create .env file
        run: |
          echo "CANVAS_API_KEY=${{ secrets.CANVAS_API_KEY }}" > .env
          # Ensure .env is not logged
          echo "Created .env file (contents hidden for security)"
        
      - name: Create course_config.json
        run: |
          cat > course_config.json << EOF
          {
            "canvas": {
              "base_url": "https://canvas.cornell.edu",
              "course_id": ${{ secrets.CANVAS_COURSE_ID }}
            },
            "github": {
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            },
            "files": {
              "metadata_file": "canvastest/assignments_metadata_5381.json"
            }
          }
          EOF
          echo "Created course_config.json"
        
      - name: Check if assignments_metadata_5381.json exists
        id: check-metadata
        run: |
          if [ -f "canvastest/assignments_metadata_5381.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found assignments_metadata_5381.json"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: assignments_metadata_5381.json not found in canvastest submodule."
            echo "This file must exist in the private canvastest repository."
          fi
        
      - name: Sync changed files to Canvas
        if: steps.changed-files.outputs.file_count > 0 && steps.check-metadata.outputs.exists == 'true'
        run: |
          # Use the sync script from canvastest/scripts directory
          Rscript canvastest/scripts/sync_changed_files.R \
            changed_assignments.txt \
            course_config.json \
            canvastest/assignments_metadata_5381.json
        
      - name: Report skipped (no changed files)
        if: steps.changed-files.outputs.file_count == 0
        run: |
          echo "No assignment files changed. Skipping Canvas sync."
        
      - name: Report skipped (no metadata)
        if: steps.changed-files.outputs.file_count > 0 && steps.check-metadata.outputs.exists == 'false'
        run: |
          echo "Warning: assignments_metadata_5381.json not found. Cannot sync files."
          echo "Please ensure canvastest/assignments_metadata_5381.json exists in the private canvastest repository."
          echo "Also verify SUBMODULE_SSH_KEY secret is configured for private submodule access."
